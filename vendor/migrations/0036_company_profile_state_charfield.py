# Generated by Django 5.1.4 on 2026-02-22 13:07

from django.db import migrations, models


STATE_CHOICES = [
    ("Andhra Pradesh", "Andhra Pradesh"),
    ("Arunachal Pradesh", "Arunachal Pradesh"),
    ("Assam", "Assam"),
    ("Bihar", "Bihar"),
    ("Chhattisgarh", "Chhattisgarh"),
    ("Goa", "Goa"),
    ("Gujarat", "Gujarat"),
    ("Haryana", "Haryana"),
    ("Himachal Pradesh", "Himachal Pradesh"),
    ("Jharkhand", "Jharkhand"),
    ("Karnataka", "Karnataka"),
    ("Kerala", "Kerala"),
    ("Madhya Pradesh", "Madhya Pradesh"),
    ("Maharashtra", "Maharashtra"),
    ("Manipur", "Manipur"),
    ("Meghalaya", "Meghalaya"),
    ("Mizoram", "Mizoram"),
    ("Nagaland", "Nagaland"),
    ("Odisha", "Odisha"),
    ("Punjab", "Punjab"),
    ("Rajasthan", "Rajasthan"),
    ("Sikkim", "Sikkim"),
    ("Tamil Nadu", "Tamil Nadu"),
    ("Telangana", "Telangana"),
    ("Tripura", "Tripura"),
    ("Uttar Pradesh", "Uttar Pradesh"),
    ("Uttarakhand", "Uttarakhand"),
    ("West Bengal", "West Bengal"),
    ("Andaman and Nicobar Islands", "Andaman and Nicobar Islands"),
    ("Chandigarh", "Chandigarh"),
    ("Dadra and Nagar Haveli and Daman and Diu", "Dadra and Nagar Haveli and Daman and Diu"),
    ("Delhi", "Delhi"),
    ("Jammu and Kashmir", "Jammu and Kashmir"),
    ("Ladakh", "Ladakh"),
    ("Lakshadweep", "Lakshadweep"),
    ("Puducherry", "Puducherry"),
]


def migrate_state_data(apps, schema_editor):
    """Copy state and shipping_state names from FK to new CharField columns."""
    CompanyProfile = apps.get_model("vendor", "CompanyProfile")
    State = apps.get_model("masters", "State")

    for cp in CompanyProfile.objects.all():
        updated = False
        if cp.state_id:
            try:
                state = State.objects.get(pk=cp.state_id)
                cp.state_new = state.name
                updated = True
            except State.DoesNotExist:
                pass
        if cp.shipping_state_id:
            try:
                state = State.objects.get(pk=cp.shipping_state_id)
                cp.shipping_state_new = state.name
                updated = True
            except State.DoesNotExist:
                pass
        if updated:
            cp.save(update_fields=["state_new", "shipping_state_new"])


def reverse_migrate_state_data(apps, schema_editor):
    """Reverse: Try to map CharField values back to State IDs (best effort)."""
    CompanyProfile = apps.get_model("vendor", "CompanyProfile")
    State = apps.get_model("masters", "State")

    state_name_to_id = {s.name: s.pk for s in State.objects.all()}

    for cp in CompanyProfile.objects.all():
        updated = False
        if cp.state_new and cp.state_new in state_name_to_id:
            cp.state_id = state_name_to_id[cp.state_new]
            updated = True
        if cp.shipping_state_new and cp.shipping_state_new in state_name_to_id:
            cp.shipping_state_id = state_name_to_id[cp.shipping_state_new]
            updated = True
        if updated:
            cp.save(update_fields=["state_id", "shipping_state_id"])


class Migration(migrations.Migration):

    dependencies = [
        ("vendor", "0035_remove_printvariant_paper_and_color_type"),
        ("masters", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="companyprofile",
            name="state_new",
            field=models.CharField(blank=True, choices=STATE_CHOICES, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name="companyprofile",
            name="shipping_state_new",
            field=models.CharField(blank=True, choices=STATE_CHOICES, max_length=100, null=True),
        ),
        migrations.RunPython(migrate_state_data, reverse_migrate_state_data),
        migrations.RemoveField(
            model_name="companyprofile",
            name="state",
        ),
        migrations.RemoveField(
            model_name="companyprofile",
            name="shipping_state",
        ),
        migrations.RenameField(
            model_name="companyprofile",
            old_name="state_new",
            new_name="state",
        ),
        migrations.RenameField(
            model_name="companyprofile",
            old_name="shipping_state_new",
            new_name="shipping_state",
        ),
    ]
