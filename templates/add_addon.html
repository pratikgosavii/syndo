{% extends "partials/adminBase.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Update{% else %}Add{% endif %} Addon{% endblock title %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body { background-color: #f8f9fa; padding-bottom: 20px; }
        .form-container { background-color: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .section-card { border: 1px solid #eee; border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem; background: #fff; }
        .section-title { font-weight: 600; color: #775599; margin-bottom: 1rem; font-size: 1rem; }
        .section-title .bi { margin-right: 0.5rem; opacity: 0.9; }
        .form-label { font-weight: 500; color: #333; }
        .btn-primary { background-color: #775599; border-color: #775599; }
        .btn-primary:hover { background-color: #5e4477; border-color: #5e4477; }
        .form-control, .form-select { border-radius: 6px; }
        .image-preview { max-height: 50px; max-width: 80px; margin-top: 10px; border-radius: 6px; border: 1px solid #dee2e6; cursor: pointer; object-fit: cover; }
        .image-fullscreen-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; cursor: pointer; }
        .image-fullscreen-overlay.show { display: flex; }
        .image-fullscreen-overlay img { max-width: 95%; max-height: 95%; object-fit: contain; pointer-events: none; }
        .searchable-select-wrap { position: relative; }
        .searchable-trigger { cursor: pointer; background-color: #fff; }
        .searchable-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 220px; background: #fff; border: 1px solid #ced4da; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1050; margin-top: 2px; flex-direction: column; overflow: hidden; }
        .searchable-dropdown.show { display: flex; }
        .searchable-dropdown-search { flex-shrink: 0; padding: 0.4rem 0.5rem; border-bottom: 1px solid #e9ecef; position: relative; }
        .searchable-dropdown-search input { width: 100%; padding: 0.35rem 0.5rem 0.35rem 1.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.8125rem; }
        .searchable-dropdown-search .bi-search { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 0.8rem; pointer-events: none; }
        .searchable-dropdown-list { max-height: 160px; overflow-y: auto; }
        .searchable-dropdown-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem; border-bottom: 1px solid #f1f3f5; }
        .searchable-dropdown-item:hover { background: #e7f1ff; }
        .searchable-dropdown-empty { padding: 0.75rem; color: #6c757d; font-size: 0.875rem; }
    </style>
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0 font-size-18"><i class="bi bi-plus-square me-2" style="color: #775599;"></i>{% if form.instance.pk %}Update{% else %}Add{% endif %} Addon</h4>
                        <a href="{% url 'list_addon' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-1"></i>Back to list</a>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="form-container">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ form.non_field_errors }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}

                        <div class="section-card">
                            <div class="section-title"><i class="bi bi-info-circle"></i>Basic information</div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="id_name" class="form-label">Addon name</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_product_category" class="form-label">Category</label>
                                    <div class="searchable-select-wrap position-relative">
                                        <input type="text" class="form-control searchable-trigger" id="category-trigger" placeholder="Select category..." readonly autocomplete="off">
                                        <i class="bi bi-chevron-down position-absolute end-0 top-50 translate-middle-y me-2 text-muted pointer-events-none"></i>
                                        <div class="searchable-dropdown" id="category-dropdown">
                                            <div class="searchable-dropdown-search">
                                                <i class="bi bi-search"></i>
                                                <input type="text" id="category-search-inner" placeholder="Search category..." autocomplete="off">
                                            </div>
                                            <div class="searchable-dropdown-list" id="category-list"></div>
                                        </div>
                                    </div>
                                    <div class="d-none">{{ form.product_category }}</div>
                                    {% if form.product_category.errors %}<div class="invalid-feedback d-block">{{ form.product_category.errors.0 }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="id_price_per_unit" class="form-label">Price per unit</label>
                                    {{ form.price_per_unit }}
                                    {% if form.price_per_unit.errors %}<div class="invalid-feedback d-block">{{ form.price_per_unit.errors.0 }}</div>{% endif %}
                                </div>
                                <div class="col-12">
                                    <label for="id_description" class="form-label">Description</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>{% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-title"><i class="bi bi-image"></i>Image</div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="id_image" class="form-label">Image</label>
                                    {{ form.image }}
                                    <div id="preview-wrapper" class="mt-2" style="{% if not form.instance or not form.instance.image %}display: none;{% endif %}">
                                        <img id="preview" class="image-preview d-block" src="{% if form.instance and form.instance.image %}{{ form.instance.image.url }}{% else %}#{% endif %}" alt="Image Preview" title="Click to view full size">
                                    </div>
                                    {% if form.image.errors %}<div class="invalid-feedback d-block">{{ form.image.errors.0 }}</div>{% endif %}
                                </div>
                            </div>
                        </div>

                        <div id="image-fullscreen-overlay" class="image-fullscreen-overlay" title="Click to close">
                            <img id="image-fullscreen-img" src="#" alt="Full size">
                        </div>

                        <div class="section-card">
                            <div class="section-title"><i class="bi bi-toggle-on"></i>Status</div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check">
                                        {{ form.is_active }}
                                        <label for="id_is_active" class="form-check-label form-label">Is active</label>
                                    </div>
                                    {% if form.is_active.errors %}<div class="invalid-feedback d-block">{{ form.is_active.errors.0 }}</div>{% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-end pt-2">
                            <a href="{% url 'list_addon' %}" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>{% if form.instance.pk %}Update{% else %}Save{% endif %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}{% include 'partials/footer.html' %}{% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script>
(function() {
    var categoryTrigger = document.getElementById('category-trigger');
    var categorySearchInner = document.getElementById('category-search-inner');
    var categoryList = document.getElementById('category-list');
    var categoryDropdown = document.getElementById('category-dropdown');
    var categorySelect = document.getElementById('id_product_category');

    var categories = [];
    if (categorySelect) {
        var opts = categorySelect.querySelectorAll('option');
        for (var i = 0; i < opts.length; i++) {
            var v = opts[i].value;
            if (v) categories.push({ id: v, name: opts[i].textContent.trim() });
        }
    }

    if (categoryTrigger && categoryList && categorySelect) {
        function esc(s) { return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        function renderCategoryList(filter) {
            var q = (filter || '').toLowerCase().trim();
            var filtered = categories.filter(function(c) { return !q || (c.name || '').toLowerCase().indexOf(q) !== -1; });
            categoryList.innerHTML = filtered.length
                ? filtered.map(function(c) { return '<div class="searchable-dropdown-item" data-id="'+esc(c.id)+'" data-name="'+esc(c.name)+'">'+esc(c.name)+'</div>'; }).join('')
                : '<div class="searchable-dropdown-empty">No category found</div>';
        }
        function closeCategory() { if (categoryDropdown) categoryDropdown.classList.remove('show'); }
        function openCategory() {
            closeCategory();
            if (categoryDropdown) categoryDropdown.classList.add('show');
            if (categorySearchInner) { categorySearchInner.value = ''; categorySearchInner.focus(); }
            renderCategoryList('');
        }
        categoryTrigger.addEventListener('click', function(e) { e.stopPropagation(); openCategory(); });
        if (categorySearchInner) categorySearchInner.addEventListener('input', function() { renderCategoryList(this.value); });
        if (categorySearchInner) categorySearchInner.addEventListener('click', function(e) { e.stopPropagation(); });
        categoryList.addEventListener('click', function(e) {
            var item = e.target.closest('.searchable-dropdown-item[data-id]');
            if (!item) return;
            categorySelect.value = item.dataset.id;
            categoryTrigger.value = item.dataset.name || item.textContent;
            closeCategory();
        });
        if (categoryDropdown) categoryDropdown.addEventListener('click', function(e) { e.stopPropagation(); });
        document.addEventListener('click', closeCategory);

        var selId = categorySelect.value;
        var sel = categories.find(function(c) { return String(c.id) === String(selId); });
        if (sel) categoryTrigger.value = sel.name;
    }

    var imageInput = document.getElementById('id_image');
    var previewImg = document.getElementById('preview');
    var previewWrapper = document.getElementById('preview-wrapper');
    if (imageInput && previewImg && previewWrapper) {
        imageInput.addEventListener('change', function() {
            var file = this.files && this.files[0];
            if (file && file.type.indexOf('image') !== -1) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewWrapper.style.display = '';
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.src = '#';
                previewWrapper.style.display = 'none';
            }
        });
    }

    var overlay = document.getElementById('image-fullscreen-overlay');
    var fullscreenImg = document.getElementById('image-fullscreen-img');
    function showFullscreen(src) {
        if (!src || src === '#') return;
        if (fullscreenImg && overlay) {
            fullscreenImg.src = src;
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }
    function hideFullscreen() {
        if (overlay) {
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
    }
    if (previewImg) previewImg.addEventListener('click', function() { showFullscreen(this.src); });
    if (overlay) overlay.addEventListener('click', hideFullscreen);
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') hideFullscreen(); });
})();
</script>
{% endblock extra_js %}
