{% extends "partials/adminBase.html" %}
{% load static %}

{% block title %}Order Details{% endblock title %}

{% block extra_css %}
    <link href="{% static 'libs/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css' %}" rel="stylesheet" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 24px;
        }
        .order-details-page .card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        .order-details-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .order-id-title {
            font-weight: 700;
            font-size: 1.5rem;
            color: #1a1d21;
            margin: 0 0 0.25rem 0;
        }
        .order-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }
        /* Order Summary card: header buttons (inside card, below title) */
        .order-summary-header-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .btn-cancel-order-outline {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 0.9375rem;
        }
        .btn-cancel-order-outline:hover { background: #FEF3C7 !important;
            border: 1px solid #F59E0B !important;
            color: #92400e !important; border-color: #c82333 !important; }
        .btn-download-bill-solid {
            background: #FEF3C7 !important;
            border: 1px solid #F59E0B !important;
            color: #92400e !important;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 0.9375rem;
            text-decoration: none;
            display: inline-block;
        }
        .btn-download-bill-solid:hover { background: #FDE68A; border-color: #D97706; color: #92400e; }
        .order-details-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            align-items: start;
        }
        @media (max-width: 992px) {
            .order-details-grid { grid-template-columns: 1fr; }
        }
        .order-items-card .card-title,
        .order-summary-card .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1a1d21;
        }
        .order-item-row {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f3f4f6;
            align-items: flex-start;
        }
        .order-item-row:last-child { border-bottom: none; }
        .order-item-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
            background: #f3f4f6;
        }
        .order-item-body {
            flex: 1;
            min-width: 0;
        }
        .order-item-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1a1d21;
            margin-bottom: 0.25rem;
        }
        .order-item-desc {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .order-item-price {
            font-weight: 600;
            color: #1a1d21;
            font-size: 1rem;
        }
        .order-item-status-tag {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        .order-summary-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .order-summary-tag {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
        }
        .order-summary-tag-status-not { background: #fecaca; color: #b91c1c; }
        .order-summary-tag-status-accepted { background: #bbf7d0; color: #166534; }
        .order-summary-tag-delivery { background: #bfdbfe; color: #1d4ed8; }
        .order-summary-tag-payment { background: #e5e7eb; color: #374151; }
        .order-summary-block {
            margin-bottom: 1.25rem;
        }
        .order-summary-block-title {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }
        .order-summary-block-content { font-size: 0.9375rem; color: #1a1d21; }
        .order-summary-block-content strong { font-weight: 600; }
        .order-summary-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.35rem;
            font-size: 0.9375rem;
        }
        .order-summary-total-block {
            border-top: 1px dashed #cbd5e1;
            padding-top: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .order-summary-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .order-summary-total-row .order-summary-block-title { margin-bottom: 0; }
        .order-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563eb;
            margin: 0;
        }
        .btn-accept-order {
            background-color: #FFC107;
            color: #1a1d21;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
            width: 100%;
        }
        .btn-accept-order:hover { background-color: #e0a800; color: #1a1d21; }
        .item-status-disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .item-status-disabled .form-select,
        .item-status-disabled .btn {
            background-color: #e9ecef;
            color: #6c757d;
        }
        .print-details-box {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        .assign-delivery-box { margin-top: 1rem; }
    </style>
{% endblock extra_css %}

{% block content %}

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid order-details-page">
            <div class="container my-4">
                <!-- Top header: Order #, meta only; Cancel + Download Bill moved into Order Summary card -->
                <div class="order-details-header">
                    <div>
                        <h1 class="order-id-title">Order #{{ data.order_id }}</h1>
                        <p class="order-meta">{{ data.created_at|date:"M d, Y, g:i a" }} • Created by Customer</p>
                    </div>
                </div>

                <div class="order-details-grid">
                    <!-- Left: Order Items -->
                    <div class="card order-items-card p-4">
                        <h2 class="card-title">Order Items ({{ data.items.all|length }})</h2>
                        {% if data.status != 'accepted' %}
                        <p class="text-muted small mb-3">Accept the order first to update item status.</p>
                        {% endif %}

                        {% for item in data.items.all %}
                        <div class="order-item-row {% if data.status != 'accepted' %}item-status-disabled{% endif %}">
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="order-item-img">
                            {% else %}
                            <img src="{% static 'images/default-product.png' %}" alt="No Image" class="order-item-img">
                            {% endif %}
                            <div class="order-item-body">
                                <div class="order-item-name">{{ item.product.name }}</div>
                                <div class="order-item-desc">{{ item.product.description|default:"No description" }}</div>
                                <div class="order-item-price">₹ {{ item.price }}</div>
                                {% if data.status == 'accepted' and item.status == 'intransit' or data.status == 'accepted' and item.status == 'delivered' or data.status == 'accepted' and item.status == 'pending' %}
                                <form action="{% url 'update_order_item_status' item.id %}" method="post" class="mt-2 d-flex align-items-center gap-2">
                                    {% csrf_token %}
                                    <select name="status" class="form-select form-select-sm" style="width: 140px;">
                                        <option value="intransit" {% if item.status == 'intransit' %}selected{% endif %}>In Transit</option>
                                        <option value="delivered" {% if item.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary btn-sm">Update</button>
                                </form>
                                {% else %}
                                <span class="order-item-status-tag">{{ item.get_status_display|upper }}</span>
                                {% endif %}
                                {% if item.print_job %}
                                <div class="print-details-box">
                                    <div class="small fw-semibold mb-2">Print details</div>
                                    {% for pf in item.print_job.files.all %}
                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                        <a href="{{ pf.file.url }}" target="_blank" class="btn btn-sm btn-primary" download>Download file</a>
                                        {% if pf.instructions %}<span class="text-muted small"><strong>Page notes:</strong> {{ pf.instructions }}</span>{% endif %}
                                        {% if pf.page_count or pf.page_numbers %}
                                        <span class="text-muted small">Pages: {% if pf.page_numbers %}{{ pf.page_numbers }}{% else %}{{ pf.page_count }}{% endif %}{% if pf.number_of_copies %} · {{ pf.number_of_copies }} copy/copies{% endif %}</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Right: Order Summary (match required UI) -->
                    <div class="card order-summary-card p-4">
                        <h2 class="card-title mb-3">Order Summary</h2>
                        <div class="order-summary-header-btns mb-3">
                            {% if data.status != 'completed' and data.status != 'cancelled' and data.status != 'cancelled_by_vendor' %}
                            <form method="post" action="{% url 'cancel_order' data.id %}" class="d-inline" onsubmit="return confirm('Cancel this order?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-download-bill-solid">Cancel Order</button>
                            </form>
                            {% endif %}
                            <a href="{% url 'order_invoice_pdf' data.id %}" target="_blank" class="btn btn-download-bill-solid">Download Bill</a>
                        </div>
                        <div class="order-summary-tags">
                            <span class="order-summary-tag order-summary-tag-status-{% if data.status == 'not_accepted' %}not{% else %}accepted{% endif %}">{{ data.get_status_display }}</span>
                            <span class="order-summary-tag order-summary-tag-delivery">{{ data.get_delivery_type_display }}</span>
                            <span class="order-summary-tag order-summary-tag-payment">{% if data.is_paid %}Paid / {{ data.payment_mode }}{% else %}Unpaid / {{ data.payment_mode|default:"COD" }}{% endif %}</span>
                        </div>

                        <div class="order-summary-block">
                            <div class="order-summary-block-title">Customer details</div>
                            <div class="order-summary-block-content">
                                <strong>{{ customer_name }}</strong><br>
                                <span class="customer-phone-plain">{{ customer_phone }}</span>
                            </div>
                        </div>

                        <div class="order-summary-block">
                            <div class="order-summary-block-title">Delivery address</div>
                            <div class="order-summary-block-content">
                                {% if data.address %}{{ data.address.full_address }}{% else %}—{% endif %}
                            </div>
                        </div>

                        <div class="order-summary-block">
                            <div class="order-summary-line"><span>Item Total</span><span>₹ {{ data.item_total }}</span></div>
                            <div class="order-summary-line"><span>Shipping Fee</span><span>₹ {{ data.shipping_fee }}</span></div>
                            <div class="order-summary-line"><span>Cashback</span><span>₹ {{ data.delivery_discount_amount|default:0 }}</span></div>
                            <div class="order-summary-line"><span>Coupon</span><span>- ₹ {{ data.coupon }}</span></div>
                        </div>

                        <div class="order-summary-block order-summary-total-block">
                            <div class="order-summary-total-row">
                                <span class="order-summary-block-title mb-0">Total Amount</span>
                                <span class="order-total-amount">₹ {{ data.total_amount }}</span>
                            </div>
                        </div>

                        {% if data.status != "accepted" %}
                        <a href="{% url 'accept_order' data.id %}" class="btn btn-accept-order">Accept Order</a>
                        {% endif %}

                        {% if data.status == "accepted" and delivery_boy_data %}
                        <div class="assign-delivery-box">
                            <form action="{% url 'assign_delivery_boy' data.id %}" method="post">
                                {% csrf_token %}
                                <div class="order-summary-block-title mb-2">Assign Delivery Boy</div>
                                <div class="input-group">
                                    <select name="delivery_boy_id" class="form-select" required>
                                        <option value="">Select delivery boy</option>
                                        {% for i in delivery_boy_data %}
                                        <option value="{{ i.id }}" {% if data.delivery_boy_id == i.id %}selected{% endif %}>{{ i.name }} {% if i.mobile %}({{ i.mobile }}){% endif %}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-success">Assign</button>
                                </div>
                            </form>
                        </div>
                        {% endif %}

                        {% if data.uengage_task_id %}
                        <div class="order-summary-block mt-2">
                            <div class="order-summary-block-title">Delivery (Uenage)</div>
                            <div class="order-summary-block-content small">
                                Task ID: {{ data.uengage_task_id }}
                                {% if data.uengage_rider_name %}<br>Rider: {{ data.uengage_rider_name }}{% endif %}
                                {% if data.uengage_rider_contact %}<br>Contact: {{ data.uengage_rider_contact }}{% endif %}
                            </div>
                        </div>
                        {% elif data.delivery_boy %}
                        <div class="order-summary-block mt-2">
                            <div class="order-summary-block-title">Delivery Boy</div>
                            <div class="order-summary-block-content small">
                                {{ data.delivery_boy.name }} · {{ data.delivery_boy.mobile }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if data.instruction %}
                <div class="card mt-3 p-3">
                    <div class="order-summary-block-title">Order note / instructions</div>
                    <p class="mb-0 text-muted">{{ data.instruction }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
{% endblock extra_js %}
