{% extends "partials/adminBase.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Customer Ledger - {{ customer.name|default:"Customer" }}{% endblock title %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<style>
    body { background-color: #f1f5f9; color: #333; }
    .ledger-page-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.25rem;
        margin-top: 0.75rem;
    }
    .ledger-page-title { font-size: 1.35rem; font-weight: 700; color: #1a1d21; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
    .ledger-page-title .bi { color: #775599; }
    .ledger-header-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .ledger-header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .btn-back-ledger {
        background: #fff !important;
        border: 1px solid #e5e7eb !important;
        color: #374151 !important;
        font-weight: 600;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-back-ledger:hover { background: #f9fafb !important; color: #1a1d21 !important; border-color: #d1d5db !important; }
    .ledger-summary-card {
        background: #151e31;
        color: #fff;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        min-width: 160px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
    }
    .ledger-summary-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em; opacity: 0.95; }
    .ledger-summary-amount { font-size: 1.35rem; font-weight: 800; letter-spacing: -0.02em; }
    .ledger-summary-card .bi { font-size: 1.15rem; opacity: 0.9; }
    .ledger-summary-card.balance-due .ledger-summary-amount { color: #fef3c7; }
    .ledger-summary-card.balance-zero .ledger-summary-amount { color: #86efac; }
    .ledger-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    .ledger-card .card-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        padding: 0.75rem 1.25rem;
        font-size: 0.7rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .ledger-table { margin-bottom: 0; font-size: 0.9rem; }
    .ledger-table thead th {
        background: #f9fafb !important;
        color: #374151;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .ledger-table tbody td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        color: #374151;
    }
    .ledger-table tbody tr:hover { background-color: #f9fafb; }
    .ledger-table tbody tr:last-child td { border-bottom: none; }
    .pill {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    .pill-sale { background: #dcfce7; color: #166534; }
    .pill-purchase { background: #fee2e2; color: #991b1b; }
    .pill-payment, .pill-receipt { background: #ccfbf1; color: #0f766e; }
    .pill-expense { background: #fef3c7; color: #92400e; }
    .pill-default { background: #f3f4f6; color: #374151; }
    .ledger-empty { text-align: center; padding: 3rem 1.5rem; color: #64748b; }
    .ledger-empty i { font-size: 2rem; color: #cbd5e1; display: block; margin-bottom: 0.5rem; }
</style>
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="ledger-page-header">
                        <div class="ledger-header-left">
                            <a href="{% url 'list_customer' %}" class="btn-back-ledger"><i class="bi bi-arrow-left"></i> Back to Customers</a>
                            <h4 class="ledger-page-title">
                                <i class="bi bi-people"></i>
                                Ledger: {% if customer %}{{ customer.name }}{% else %}Customer #{{ customer_id }}{% endif %}
                            </h4>
                        </div>
                        <div class="ledger-header-right">
                            <div class="ledger-summary-card {% if balance > 0 %}balance-due{% else %}balance-zero{% endif %}">
                                <div>
                                    <div class="ledger-summary-label">CURRENT BALANCE</div>
                                    <div class="ledger-summary-amount">₹ {{ balance|floatformat:2|intcomma }}</div>
                                </div>
                                <i class="bi bi-currency-rupee"></i>
                            </div>
                            <div class="ledger-summary-card">
                                <div>
                                    <div class="ledger-summary-label">TOTAL SALES</div>
                                    <div class="ledger-summary-amount">₹ {{ total_sales|floatformat:2|intcomma }}</div>
                                </div>
                                <i class="bi bi-cart-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="ledger-card">
                        <div class="card-header">Transactions</div>
                        <div class="table-responsive">
                            <table class="table ledger-table mb-0" data-enable-filters="false">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Reference</th>
                                        <th class="text-end">Opening (₹)</th>
                                        <th class="text-end">Amount (₹)</th>
                                        <th class="text-end">Balance (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if ledger %}
                                        {% for entry in ledger %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ entry.created_at|date:"d M Y, H:i" }}</td>
                                            <td><span class="pill {{ entry.transaction_type|ledger_type_pill_class }}">{{ entry.get_transaction_type_display|default:entry.transaction_type }}</span></td>
                                            <td>{{ entry.description|default:"–" }}</td>
                                            <td>{{ entry.reference_id|default:"–" }}</td>
                                            <td class="text-end">₹ {{ entry.opening_balance|floatformat:2|intcomma }}</td>
                                            <td class="text-end">₹ {{ entry.amount|floatformat:2|intcomma }}</td>
                                            <td class="text-end fw-semibold">₹ {{ entry.balance_after|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8">
                                                <div class="ledger-empty">
                                                    <i class="bi bi-journal-text"></i>
                                                    <p class="mb-0 fw-medium">No ledger entries yet</p>
                                                    <p class="mb-0 small">Transactions will appear here.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}{% include 'partials/footer.html' %}{% endblock footer %}
</div>
{% endblock content %}
