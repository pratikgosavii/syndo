{% extends "partials/adminBase.html" %}
{% load static %}

{% block title %}Add Purchase{% endblock title %}


{% block extra_css %}
    <!-- plugin css -->
   <link href="{% static 'libs/select2/dist/css/select2.min.css'%}" rel="stylesheet" type="text/css" />
 <link href="{% static 'libs/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css' %}" rel="stylesheet" type="text/css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        /* Page: exact match to reference - light grey background */
        body { background-color: #F5F7FA; padding-bottom: 20px; }
        .form-container { background-color: transparent; padding: 0; }
        /* Cards: white, rounded corners, subtle shadow */
        .section-card { border: 1px solid #e9ecef; border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        /* Section titles: dark grey, font-weight 600, icons peach/orange */
        .section-title { font-weight: 600; color: #333; margin-bottom: 1rem; font-size: 1.1rem; }
        .section-title .bi { margin-right: 0.5rem; color: #FD7E14; }
        .form-label { font-weight: 500; color: #495057; }
        /* Inputs: white bg, light grey border, rounded */
        .section-card .form-control, .section-card .form-select { 
            border: 1px solid #CED4DA; background: #fff; border-radius: 5px; 
        }
        .section-card .form-control:focus, .section-card .form-select:focus { 
            border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); 
        }
        /* Payment section: clean card without grey header */
        .payment-section-card { border: 1px solid #e9ecef; border-radius: 10px; margin-bottom: 1.5rem; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.06); overflow: hidden; }
        .payment-section-card .payment-section-body { padding: 1.25rem; background: #fff; }
        .payment-section-card .payment-section-body .form-label { color: #495057; }
        .payment-section-card .payment-section-body .form-control,
        .payment-section-card .payment-section-body .form-select { border: 1px solid #CED4DA; background: #fff; border-radius: 5px; }
        /* Payment buttons: inactive white, active light blue */
        .btn-payment { background: #fff; border: 1px solid #CED4DA; color: #333; border-radius: 5px; }
        .btn-payment.btn-payment-active { background-color: #E0F2F7; border-color: #E0F2F7; color: #007BFF; }
        .btn-payment:not(.btn-payment-active):hover { border-color: #adb5bd; color: #495057; background: #fff; }

        textarea[name="references"], textarea[name="notes"], textarea[name="terms"] { min-height: 80px; resize: vertical; width: 100%; border: 1px solid #CED4DA; border-radius: 5px; }
        .btn-primary { background-color: #007BFF; border-color: #007BFF; }
        .btn-primary:hover { background-color: #0056b3; border-color: #0056b3; }
        /* + New Vendor */
        .btn-new-vendor { background-color: #FCA311 !important; border: 1px solid #FCA311 !important; color: #fff; font-weight: 600; }
        .btn-new-vendor:hover { background-color: #e5920f !important; border-color: #e5920f !important; color: #fff; }
        /* + Add Row: light blue bg, blue border, white text */
        .btn-add-row { background-color: #0D6EFD; border: 1px solid #0D6EFD; color: #fff; font-weight: 600; }
        .btn-add-row:hover { background-color: #0b5ed7; border-color: #0b5ed7; color: #fff; }
        /* + Add to Catalog: transparent/grey, dark text */
        .btn-add-catalog { background: #E9ECEF; border: 1px solid #CED4DA; color: #495057; }
        .btn-add-catalog:hover { background: #dee2e6; border-color: #adb5bd; color: #495057; }
        .btn-remove-x { width: 36px; height: 36px; padding: 0; display: inline-flex; align-items: center; justify-content: center; background: #DC3545; border: none; border-radius: 6px; color: #fff; }
        .btn-remove-x:hover { background: #bb2d3b; color: #fff; }
        .purchase-code-readonly { background-color: #e9ecef !important; color: #6c757d; }
        .subtotal-row { border-top: 1px solid #dee2e6; padding-top: 0.75rem; margin-top: 0.75rem; font-size: 1rem; font-weight: 600; }
    </style>

     <style>
    /* Custom Toggle Switch */
    .switch {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: orange;
    }

    input:checked + .slider:before {
        transform: translateX(22px);
    }
</style>


{% endblock extra_css %}

{% block content %}

<div class="main-content">
    <div class="page-content">
      <div class="container-fluid">
        <!-- start page title -->
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0 fw-bold" style="font-size: 1.5rem; color: #333;">Add Purchase</h4>
                </div>
            </div>
        </div>

      



        <div class="container">
          <div class="form-container">
            <form method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <!-- Transaction Details -->
              <div class="section-card">
                <h6 class="section-title"><i class="bi bi-receipt"></i> Transaction Details</h6>
                <div class="row g-3">
                  <div class="col-md-2">
                    <label class="form-label">Purchase Code</label>
                    {% if form.instance.pk %}
                      <strong class="form-control-plaintext">{{ form.instance.purchase_code }}</strong>
                    {% else %}
                      <div class="form-control purchase-code-readonly" readonly>Auto-generated</div>
                      <input type="hidden" name="purchase_code" value="">
                    {% endif %}
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Purchase Date</label>
                    {{ form.purchase_date }}
                    {% if form.purchase_date.errors %}<div class="text-danger small mt-1">{{ form.purchase_date.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Supplier Invoice Date</label>
                    {{ form.supplier_invoice_date }}
                    {% if form.supplier_invoice_date.errors %}<div class="text-danger small mt-1">{{ form.supplier_invoice_date.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Vendor</label>
                    <div class="d-flex gap-2 align-items-start">
                      <div class="flex-grow-1">{{ form.vendor }}</div>
                      <a href="{% url 'add_vendor' %}" class="btn btn-new-vendor btn-sm flex-shrink-0" target="_blank">
                        <i class="bi bi-plus"></i> New Vendor
                      </a>
                    </div>
                    {% if form.vendor.errors %}<div class="text-danger small mt-1">{{ form.vendor.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Supplier Serial Number</label>
                    {{ form.serial_number }}
                    {% if form.serial_number.errors %}<div class="text-danger small mt-1">{{ form.serial_number.errors.0 }}</div>{% endif %}
                  </div>
                </div>
              </div>

              <!-- Product Items -->
              <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="section-title mb-0"><i class="bi bi-box"></i> Product Items</h6>
                  <a href="{% url 'add_product' %}" class="btn btn-add-catalog btn-sm">
                    <i class="bi bi-plus"></i> Add to Catalog
                  </a>
                </div>
                <select id="product-options" style="display:none;">
                  {% for p in data %}<option value="{{ p.id }}" data-gst="{{ p.gst|default:18 }}">{{ p.name }}</option>{% endfor %}
                </select>
                <div class="row fw-bold border-bottom pb-2 mb-2 text-uppercase small" style="color: #495057;">
                  <div class="col-md-4">Product</div>
                  <div class="col-md-2">Quantity</div>
                  <div class="col-md-2">Purchase Price (â‚¹)</div>
                  <div class="col-md-2">Total (â‚¹)</div>
                  <div class="col-md-2"></div>
                </div>
                <div id="products-wrapper">
                  {% for item in existing_items %}
                  <div class="product-row row g-2 mb-2 align-items-center">
                    <div class="col-md-4">
                      <select name="products" class="form-control product-select">
                        <option value="">Select Product</option>
                        {% for p in data %}
                          <option value="{{ p.id }}" {% if p.id == item.product_id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-2">
                      <input type="number" name="quantity" class="form-control quantity" placeholder="Qty" min="1" value="{{ item.quantity|default:1 }}">
                    </div>
                    <div class="col-md-2">
                      <input type="text" name="price" class="form-control price" placeholder="Price" value="{{ item.price|default:'' }}">
                    </div>
                    <div class="col-md-2">
                      <input type="text" name="total_price" class="form-control total-price" placeholder="Total" readonly value="{{ item.total|default:'' }}">
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-remove-x remove-row" title="Remove"><i class="bi bi-x"></i></button>
                    </div>
                  </div>
                  {% empty %}
                  <div class="product-row row g-2 mb-2 align-items-center">
                    <div class="col-md-4">
                      <select name="products" class="form-control product-select">
                        <option value="">Select Product</option>
                        {% for p in data %}<option value="{{ p.id }}" data-gst="{{ p.gst|default:18 }}">{{ p.name }}</option>{% endfor %}
                      </select>
                    </div>
                    <div class="col-md-2">
                      <input type="number" name="quantity" class="form-control quantity" placeholder="Qty" min="1" value="1">
                    </div>
                    <div class="col-md-2">
                      <input type="text" name="price" class="form-control price" placeholder="Price">
                    </div>
                    <div class="col-md-2">
                      <input type="text" name="total_price" class="form-control total-price" placeholder="Total" readonly>
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-remove-x remove-row" title="Remove"><i class="bi bi-x"></i></button>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="mt-2">
                  <button type="button" class="btn btn-add-row btn-sm" id="add-product">
                    <i class="bi bi-plus"></i> Add Row
                  </button>
                </div>
              </div>

              <!-- Logistics & Shipping -->
              <div class="section-card">
                <h6 class="section-title"><span class="logistics-emoji">ðŸšš</span> Logistics & Shipping</h6>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Shipping / Delivery Charges</label>
                    {{ form.delivery_shipping_charges }}
                    {% if form.delivery_shipping_charges.errors %}<div class="text-danger small">{{ form.delivery_shipping_charges.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Packaging Charges</label>
                    {{ form.packaging_charges }}
                    {% if form.packaging_charges.errors %}<div class="text-danger small">{{ form.packaging_charges.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Transport Number</label>
                    {{ form.transport_name }}
                    {% if form.transport_name.errors %}<div class="text-danger small">{{ form.transport_name.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">E-way Bill No</label>
                    {{ form.eway_bill_no }}
                    {% if form.eway_bill_no.errors %}<div class="text-danger small">{{ form.eway_bill_no.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">LR Number</label>
                    {{ form.lr_no }}
                    {% if form.lr_no.errors %}<div class="text-danger small">{{ form.lr_no.errors.0 }}</div>{% endif %}
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Vehicle Number</label>
                    {{ form.vehicle_no }}
                    {% if form.vehicle_no.errors %}<div class="text-danger small">{{ form.vehicle_no.errors.0 }}</div>{% endif %}
                  </div>
                </div>
              </div>

              <!-- Notes/Terms + Payment Method (two columns) -->
              <div class="row g-3 mb-4">
                <div class="col-lg-6">
                  <div class="section-card h-100">
                    <div class="mb-3" style="display:none;">
                      <label for="references" class="form-label">References</label>
                      {{ form.references }}
                    </div>
                    <div class="mb-3">
                      <label for="notes" class="form-label">Notes</label>
                      {{ form.notes }}
                      {% if form.notes.errors %}<div class="text-danger small">{{ form.notes.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="mb-0">
                      <label for="terms" class="form-label">Terms</label>
                      {{ form.terms }}
                      {% if form.terms.errors %}<div class="text-danger small">{{ form.terms.errors.0 }}</div>{% endif %}
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
              <!-- Payment Method -->
              <div class="payment-section-card mb-0 h-100">
                <div class="payment-section-body" style="padding-top: 1.25rem;">
                  <label class="form-label d-block mb-3">Payment Method</label>
                  <div class="mb-3">
                    <div class="btn-group btn-group-sm d-flex btn-group-payment" role="group" aria-label="Payment method">
                      <button type="button" class="btn btn-payment {% if form.instance.payment_method == 'cash' or not form.instance.payment_method %}btn-payment-active{% endif %}" onclick="selectPayment('cash', this)">Cash</button>
                      <button type="button" class="btn btn-payment {% if form.instance.payment_method == 'upi' %}btn-payment-active{% endif %}" onclick="selectPayment('upi', this)">UPI</button>
                      <button type="button" class="btn btn-payment {% if form.instance.payment_method == 'cheque' %}btn-payment-active{% endif %}" onclick="selectPayment('cheque', this)">Cheque</button>
                      <button type="button" class="btn btn-payment {% if form.instance.payment_method == 'credit' %}btn-payment-active{% endif %}" onclick="selectPayment('credit', this)">Credit</button>
                    </div>
                    {% if form.payment_method.errors %}<div class="text-danger small mt-1">{{ form.payment_method.errors.0 }}</div>{% endif %}
                    <input type="hidden" name="payment_method" id="payment_method" value="{{ form.instance.payment_method|default:'cash' }}" required>
                  </div>
                  <div id="advance-bank-dropdown" class="mb-3" style="display: none;">
                    <label class="form-label">Select Bank (If Cheque/Online)</label>
                    <select name="advance_bank" id="advance_bank" class="form-select">
                      <option value="">Select Bank Account</option>
                      {% for bank in banks %}
                      <option value="{{ bank.id }}" {% if form.instance.advance_bank and form.instance.advance_bank.id == bank.id %}selected{% endif %}>{{ bank.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="row g-3 mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Discount (â‚¹)</label>
                      {{ form.discount_amount }}
                      {% if form.discount_amount.errors %}<div class="text-danger small">{{ form.discount_amount.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Discount (%)</label>
                      {{ form.discount_percentage }}
                      {% if form.discount_percentage.errors %}<div class="text-danger small">{{ form.discount_percentage.errors.0 }}</div>{% endif %}
                    </div>
                  </div>
                  <div id="credit_time" style="display: none;">
                    <div class="row g-3 mb-3">
                      <div class="col-md-4">
                        <label class="form-label">Advance amount</label>
                        {{ form.advance_payment_amount }}
                        {% if form.advance_amount.errors %}<div class="text-danger small">{{ form.advance_amount.errors.0 }}</div>{% endif %}
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Advance payment mode</label>
                        <div class="btn-group btn-group-sm" role="group">
                          <button type="button" class="btn btn-payment btn-payment-active" onclick="selectAdvancePayment('cash', this)">Cash</button>
                          <button type="button" class="btn btn-payment" onclick="selectAdvancePayment('bank', this)">Bank</button>
                        </div>
                        <input type="hidden" name="advance_payment_method" id="advance_payment_method" value="cash" required>
                      </div>
                    </div>
                    <div class="mb-3" id="due_date_wrapper" style="display: none;">
                      <label class="form-label">Due date</label>
                      <input type="date" class="form-control" name="due_date" id="due_date" value="{{ form.instance.due_date|date:'Y-m-d' }}">
                      {% if form.due_date.errors %}<div class="text-danger small">{{ form.due_date.errors.0 }}</div>{% endif %}
                    </div>
                  </div>
                  <div class="border-top pt-3 mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>Total Products:</span><strong id="total-products">0</strong></div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>Subtotal:</span><strong>â‚¹ <span id="subtotal-display">0.00</span></strong></div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>Total GST:</span><strong>â‚¹ <span id="total-gst-display">0.00</span></strong></div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>Shipping / Delivery Charges:</span><strong>â‚¹ <span id="shipping-display">0.00</span></strong></div>
                    <div class="d-flex justify-content-between align-items-center mb-2"><span>Discount:</span><strong>â‚¹ <span id="discount-display">0.00</span></strong></div>
                    <div class="subtotal-row d-flex justify-content-between align-items-center">
                      <span>Total Amount:</span>
                      <strong class="fs-5">â‚¹ <span id="total-amount-display">0.00</span></strong>
                    </div>
                  </div>
                </div>
              </div>
                </div>
              </div>
         

              {% comment %} <div class="border rounded p-3 bg-white shadow-sm mb-4">
                <h5 class="fw-bold mb-3">Summary</h5>
                <p>Total Items: <span id="total-items">0</span></p>
                <p>Total Amount before Discount: â‚¹<span id="total-amount-before-discount">0.00</span></p>
                <p>Discount: â‚¹<span id="discount-amount">0.00</span></p>
                <p>Total Amount: â‚¹<span id="total-amount">0.00</span></p>

                <hr>

                <div id="advance_summary" style="display:none">
                  <p>Advance Payment: â‚¹<span id="advance-amount">0.00</span></p>
                  <p>Advance Mode: <span id="advance-mode">Cash</span> 
                      <span id="advance-bank-name" style="display:none;">(Bank Name)</span>
                  </p>
                </div>

                <p><strong>Net Payable: â‚¹<span id="net-payable">0.00</span></strong></p>
                
              </div> {% endcomment %}

                                <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary custom-button">Submit</button>
            </div>
        </form>
    </div>

</div>
</div>
      </div>
          <!-- container-fluid -->
  </div>
    <!-- End Page-content -->

    {% block footer %}
        {% include 'partials/footer.html' %}
    {% endblock footer %}
</div>

{% endblock content %}


{% block extra_js %}
    <!-- apexcharts -->
    <script src="{% static 'libs/apexcharts/dist/apexcharts.min.js' %}"></script>
    <script>
        // Image preview logic
       
    </script>
    <script>
        // Auto-hide toast after 5 seconds
        setTimeout(() => {
            const toastElement = document.getElementById("toast");
            if (toastElement) {
                toastElement.classList.remove("show"); // Hide toast
                setTimeout(() => {
                    toastElement.remove(); // Remove from DOM
                }, 500); // Wait for fade-out animation
            }
        }, 5000);
    </script>

    <!-- Plugins js-->
   

    <script>

        
function displaySelectedImages() {
    const input = document.getElementById("images");
    const selectedImagesContainer = document.getElementById("imagesPreview");
    selectedImagesContainer.innerHTML = ""; // Clear previously displayed images

    Array.from(input.files).forEach((file) => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const imageDiv = document.createElement("div");
          imageDiv.style.position = "relative";
          const img = document.createElement("img");
          img.src = event.target.result;
          img.alt = file.name;
          img.style.width = "100px";
          img.style.height = "100px";
          img.style.objectFit = "cover";
          img.style.border = "1px solid #ddd";
          img.style.borderRadius = "5px";
          imageDiv.appendChild(img);
          selectedImagesContainer.appendChild(imageDiv);
        };
        reader.readAsDataURL(file);
      }
    });
  }



  

    </script>

  <script src="{% static 'libs/select2/dist/js/select2.min.js'%}"></script>

    <!-- init js -->
    <script src="{% static 'js/pages/ecommerce-select2.init.js'%}"></script>

    <script>
        


  
</script>

<script>
function createProductRow() {
    const row = document.createElement('div');
    row.className = 'product-row row g-2 mb-2 align-items-center';

    // Product select
    const colProduct = document.createElement('div');
    colProduct.className = 'col-md-4';
    const select = document.createElement('select');
    select.name = 'products';
    select.className = 'form-control product-select';
    select.innerHTML = document.getElementById('product-options').innerHTML;
    colProduct.appendChild(select);

    // Quantity
    const colQty = document.createElement('div');
    colQty.className = 'col-md-2';
    const qty = document.createElement('input');
    qty.type = 'number';
    qty.name = 'quantity';
    qty.className = 'form-control quantity';
    qty.value = 1;
    qty.min = 1;
    colQty.appendChild(qty);

    // Price
    const colPrice = document.createElement('div');
    colPrice.className = 'col-md-2';
    const price = document.createElement('input');
    price.type = 'text';
    price.name = 'price';
    price.className = 'form-control price';
    price.placeholder = 'Price';
    colPrice.appendChild(price);

    // Total
    const colTotal = document.createElement('div');
    colTotal.className = 'col-md-2';
    const total = document.createElement('input');
    total.type = 'text';
    total.name = 'total_price';
    total.className = 'form-control total-price';
    total.placeholder = 'Total';
    total.readOnly = true;
    colTotal.appendChild(total);

    // Remove
    const colRemove = document.createElement('div');
    colRemove.className = 'col-md-2';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-remove-x remove-row';
    removeBtn.title = 'Remove';
    removeBtn.innerHTML = '<i class="bi bi-x"></i>';
    colRemove.appendChild(removeBtn);

    // Append all cols to row
    row.appendChild(colProduct);
    row.appendChild(colQty);
    row.appendChild(colPrice);
    row.appendChild(colTotal);
    row.appendChild(colRemove);

    return row;
}

// Add new product row
document.getElementById('add-product').addEventListener('click', function () {
    const productOptions = document.getElementById('product-options');
    if (!productOptions || !productOptions.options.length) return;
    const wrapper = document.getElementById('products-wrapper');
    const newRow = createProductRow();
    wrapper.appendChild(newRow);
    $(newRow).find('.product-select').select2({placeholder:'Select Product', width:'100%'});
    updateSubtotal();
});

// Init Select2 on existing product rows (e.g. first row on new purchase, or rows on edit)
document.addEventListener('DOMContentLoaded', function () {
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('.product-select').select2({placeholder: 'Select Product', width: '100%'});
    }
});

// Remove row
document.addEventListener('click', function (e) {
    const btn = e.target.closest('.remove-row');
    if (btn) {
        const rows = document.querySelectorAll('.product-row');
        if (rows.length > 1) {
            btn.closest('.product-row').remove();
            updateSubtotal();
        }
    }
});

// Fetch price on product change
$(document).on('select2:select', '.product-select', function (e) {
    const $row = $(this).closest('.product-row');
    const productId = $(this).val();
    const qty = parseFloat($row.find('.quantity').val()) || 0;

    $.ajax({
        url: "{% url 'get_product_price' %}",
        data: { product_id: productId },
        success: function(data){
            const price = parseFloat(data.price) || 0;
            $row.find('.price').val(price.toFixed(2));
            $row.find('.total-price').val((qty*price).toFixed(2));
            if (typeof updateSubtotal === 'function') updateSubtotal();
        },
        error: function(){
            $row.find('.price').val('');
            $row.find('.total-price').val('');
            if (typeof updateSubtotal === 'function') updateSubtotal();
        }
    });
});


// Update total on quantity change
document.addEventListener('input', function(e){
    if(e.target.classList.contains('quantity')){
        const row = e.target.closest('.product-row');
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const qty = parseFloat(e.target.value) || 0;
        row.querySelector('.total-price').value = (price*qty).toFixed(2);
        updateSubtotal();
    }
});

// Update total on price change
document.addEventListener('input', function(e){
    if(e.target.classList.contains('price')){
        const row = e.target.closest('.product-row');
        const qty = parseFloat(row.querySelector('.quantity').value) || 0;
        const price = parseFloat(e.target.value) || 0;
        row.querySelector('.total-price').value = (price*qty).toFixed(2);
        updateSubtotal();
    }
});

function recalculateTotals() {
    let totalProducts = 0;
    let subtotal = 0;
    let gstTotal = 0;
    document.querySelectorAll('.product-row').forEach(function(row) {
        const qty = parseFloat(row.querySelector('.quantity')?.value) || 0;
        const price = parseFloat(row.querySelector('.price')?.value) || 0;
        const amount = qty * price;
        const sel = row.querySelector('.product-select');
        const gstRate = (sel?.selectedOptions?.[0]?.getAttribute('data-gst')) ? parseFloat(sel.selectedOptions[0].getAttribute('data-gst')) : 18;
        const rowGst = amount * (gstRate / 100);
        totalProducts += qty;
        subtotal += amount;
        gstTotal += rowGst;
    });
    const deliveryEl = document.getElementById('id_delivery_shipping_charges');
    const packagingEl = document.getElementById('id_packaging_charges');
    const shipping = (parseFloat(deliveryEl?.value) || 0) + (parseFloat(packagingEl?.value) || 0);

    const discountPctEl = document.getElementById('discount-percentage');
    const discountAmtEl = document.getElementById('discount-amount-input');
    const subtotalBeforeDiscount = subtotal;
    let discountAmount = 0;
    let discountPercentage = 0;
    if (discountPctEl && discountAmtEl) {
        if (document.activeElement === discountPctEl) {
            discountPercentage = parseFloat(discountPctEl.value) || 0;
            discountAmount = subtotalBeforeDiscount * (discountPercentage / 100);
            discountAmtEl.value = discountAmount.toFixed(2);
        } else if (document.activeElement === discountAmtEl) {
            discountAmount = parseFloat(discountAmtEl.value) || 0;
            discountPercentage = (subtotalBeforeDiscount === 0) ? 0 : (discountAmount / subtotalBeforeDiscount) * 100;
            discountPctEl.value = discountPercentage.toFixed(2);
        } else {
            discountPercentage = parseFloat(discountPctEl.value) || 0;
            discountAmount = subtotalBeforeDiscount * (discountPercentage / 100);
            discountAmtEl.value = discountAmount.toFixed(2);
        }
    }

    const totalAmount = (subtotal - discountAmount) + gstTotal + shipping;
    const fmt = (n) => (n || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    const el = function(id) { return document.getElementById(id); };
    if (el('total-products')) el('total-products').textContent = totalProducts;
    if (el('subtotal-display')) el('subtotal-display').textContent = fmt(subtotal);
    if (el('total-gst-display')) el('total-gst-display').textContent = fmt(gstTotal);
    if (el('shipping-display')) el('shipping-display').textContent = fmt(shipping);
    if (el('discount-display')) el('discount-display').textContent = fmt(discountAmount);
    if (el('total-amount-display')) el('total-amount-display').textContent = fmt(totalAmount);
}

function updateSubtotal() { recalculateTotals(); }

document.addEventListener('DOMContentLoaded', function() {
    recalculateTotals();
    const discountPct = document.getElementById('discount-percentage');
    const discountAmt = document.getElementById('discount-amount-input');
    const delivery = document.getElementById('id_delivery_shipping_charges');
    const packaging = document.getElementById('id_packaging_charges');
    if (discountPct) discountPct.addEventListener('input', recalculateTotals);
    if (discountAmt) discountAmt.addEventListener('input', recalculateTotals);
    if (delivery) delivery.addEventListener('input', recalculateTotals);
    if (packaging) packaging.addEventListener('input', recalculateTotals);
});
</script>


<script>
  // existing functions (keep as before), but ensure they also toggle .btn-outline-dark <-> .btn-warning
  function selectPayment(method, btn) {
    console.log('ddfdfd')
    document.getElementById('payment_method').value = method;

    var group = btn.closest('.btn-group');
    if (group) group.querySelectorAll('.btn-payment').forEach(function(b) { b.classList.remove('btn-payment-active'); });
    btn.classList.add('btn-payment-active');

    document.getElementById('credit_time').style.display = method === 'credit' ? 'block' : 'none';

    document.getElementById('due_date_wrapper').style.display = (method === 'credit') ? 'block' : 'none';

    const bankDropdown = document.getElementById('advance-bank-dropdown');
    const bankSelect = document.getElementById('advance_bank');

    if (method !== 'cash') {
    console.log(method)

      bankDropdown.style.display = 'block';
      bankSelect.setAttribute('required', 'required');
    } else {
    console.log(method)

      bankDropdown.style.display = 'none';
      bankSelect.removeAttribute('required');
      bankSelect.value = ""; // reset when hidden
    }

      if (method === 'credit') {
    const advanceCashBtn = document.querySelector(
      "[onclick*=\"selectAdvancePayment('cash'\"]"
    );
    if (advanceCashBtn) {
      advanceCashBtn.click(); // trigger JS + UI update
    }
  }

  }

  function selectAdvanceMode(mode, btn) {
    document.getElementById('advance_mode').value = mode;
    document.querySelectorAll("[onclick^='selectAdvanceMode']").forEach(b => {
      b.classList.remove('btn-warning');
      b.classList.add('btn-outline-dark');
    });
    btn.classList.remove('btn-outline-dark');
    btn.classList.add('btn-warning');
  }

  // Run on page load to ensure UI matches values coming from server
  document.addEventListener('DOMContentLoaded', function () {
    var currentPayment = document.getElementById('payment_method').value || 'cash';
    // find the button for that payment and trigger the same UI changes
    document.querySelectorAll("[onclick^='selectPayment']").forEach(function (b) {
      // b.onclick attribute contains call like selectPayment('upi', this) => extract method from attribute
      var onclick = b.getAttribute('onclick') || '';
      if (onclick.indexOf("'" + currentPayment + "'") !== -1) {
        // manually call selectPayment with element to set classes and due date visibility
        selectPayment(currentPayment, b);
      }
    });

    // advance mode

    // if payment is credit and due_date has a value, ensure wrapper visible (extra safety)
    if (currentPayment === 'credit') {
      document.getElementById('due_date_wrapper').style.display = 'block';
    }
  });

{% comment %}   
function recalculateTotals() {
    let totalItems = 0;
    let totalAmount = 0;

    document.querySelectorAll('.item-row').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.rate-input').value) || 0;
        const amount = qty * price;

        row.querySelector('.amount').value = amount.toFixed(2);
        totalItems += qty;
        totalAmount += amount;
    });

    const discountPercentageField = document.getElementById('discount-percentage');
    const discountAmountField = document.getElementById('discount-amount-input');
    const advanceAmountField = document.getElementById('advance_payment_method');

    let discountAmount = 0;
    let discountPercentage = 0;

    // Two-way discount binding
    if (document.activeElement === discountPercentageField) {
        discountPercentage = parseFloat(discountPercentageField.value) || 0;
        discountAmount = totalAmount * (discountPercentage / 100);
        discountAmountField.value = discountAmount.toFixed(2);
    } else if (document.activeElement === discountAmountField) {
        discountAmount = parseFloat(discountAmountField.value) || 0;
        discountPercentage = (totalAmount === 0) ? 0 : (discountAmount / totalAmount) * 100;
        discountPercentageField.value = discountPercentage.toFixed(2);
    } else {
        discountPercentage = parseFloat(discountPercentageField.value) || 0;
        discountAmount = totalAmount * (discountPercentage / 100);
        discountAmountField.value = discountAmount.toFixed(2);
    }

    const amountAfterDiscount = totalAmount - discountAmount;
    const advanceAmount = parseFloat(advanceAmountField.value) || 0;
    const netPayable = amountAfterDiscount - advanceAmount;

    // Update summary
    document.getElementById('total-items').innerText = totalItems;
    document.getElementById('total-amount-before-discount').innerText = totalAmount.toFixed(2);
    document.getElementById('discount-amount').innerText = discountAmount.toFixed(2);
    document.getElementById('total-amount').innerText = amountAfterDiscount.toFixed(2);

    // New: update advance and net payable
    document.getElementById('advance-amount').innerText = advanceAmount.toFixed(2);

    const mode = document.getElementById('advance_payment_method').value;
    document.getElementById('advance-mode').innerText = mode.charAt(0).toUpperCase() + mode.slice(1);

    const bankSelect = document.getElementById('advance_bank');
    if (mode === 'bank' && bankSelect && bankSelect.value) {
        document.getElementById('advance-bank-name').style.display = 'inline';
        document.getElementById('advance-bank-name').innerText = `(${bankSelect.options[bankSelect.selectedIndex].text})`;
    } else {
        document.getElementById('advance-bank-name').style.display = 'none';
    }

    document.getElementById('net-payable').innerText = netPayable.toFixed(2);
} {% endcomment %}



function selectAdvancePayment(method, btn) {
    document.getElementById('advance_payment_method').value = method;
    btn.closest('.btn-group').querySelectorAll('.btn-payment').forEach(function(b) {
        b.classList.remove('btn-payment-active');
    });
    btn.classList.add('btn-payment-active');

    // Show/hide bank dropdown
    if (method === 'bank') {
        document.getElementById('advance-bank-dropdown').style.display = 'block';
        
    } else {
        document.getElementById('advance-bank-dropdown').style.display = 'none';
        document.getElementById('advance_bank').value = ''; // clear bank
    }


}


document.addEventListener('DOMContentLoaded', function() {
    const method = document.getElementById('advance_payment_method').value;
    const btn = document.querySelector(`[onclick="selectAdvancePayment('${method}', this)"]`);
    if (btn) selectAdvancePayment(method, btn);
});




</script>


      

{% endblock extra_js %}