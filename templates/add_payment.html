{% extends "partials/adminBase.html" %}
{% load static %}

{% block title %}Add Payment{% endblock title %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<style>
  body { background-color: #f1f5f9; padding-bottom: 20px; }
  .payment-form-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    border: 1px solid #e9ecef;
    padding: 1.5rem 2rem;
    position: relative;
  }
  .payment-form-title { font-size: 1.5rem; font-weight: 700; color: #1a1d21; margin-bottom: 1.5rem; }
  /* Top right info box */
  .payment-info-box {
    position: absolute;
    top: 1.5rem;
    right: 2rem;
    background: #FEF3C7;
    border: 1px solid #F59E0B;
    color: #92400e;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .payment-section-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }
  .payment-form-card .form-label { font-weight: 500; color: #374151; }
  .payment-form-card .form-control, .payment-form-card .form-select {
    border: 1px solid #ced4da;
    border-radius: 6px;
    background: #fff;
  }
  .payment-form-card .form-control:focus, .payment-form-card .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    outline: none;
  }
  /* Transaction type buttons - You Gave = red when selected, You Received = green when selected */
  .btn-transaction { background: #fff; border: 1px solid #e5e7eb; color: #374151; border-radius: 6px; }
  .btn-transaction-gave.btn-transaction-active { background: #dc2626 !important; border-color: #dc2626 !important; color: #fff !important; }
  .btn-transaction-received.btn-transaction-active { background: #22c55e !important; border-color: #22c55e !important; color: #fff !important; }
  .btn-transaction:not(.btn-transaction-active):hover { border-color: #9ca3af; }
  /* Party type buttons */
  .btn-party { background: #fff; border: 1px solid #e5e7eb; color: #374151; border-radius: 6px; }
  .btn-party.btn-party-active { background: #fff; border-color: #3b82f6; color: #3b82f6; }
  .btn-party:not(.btn-party-active):hover { border-color: #9ca3af; }
  /* Payment mode - Cash blue when active */
  .btn-payment { background: #f3f4f6; border: 1px solid #e5e7eb; color: #6b7280; border-radius: 6px; }
  .btn-payment.btn-payment-active { background: #FEF3C7; border-color: #F59E0B; color: #92400e; }
  .btn-payment:not(.btn-payment-active):hover { border-color: #9ca3af; color: #374151; }
  /* File upload */
  .payment-file-upload {
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    background: #f9fafb;
    cursor: pointer;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .payment-file-upload:hover { border-color: #3b82f6; background: #f3f4f6; }
  .payment-file-upload .bi-paperclip { font-size: 2rem; color: #9ca3af; }
  .payment-file-upload input[type="file"] { display: none; }
  .payment-file-upload.has-file { border-color: #22c55e; background: #f0fdf4; }
  .btn-discard { background: #fff; border: 1px solid #dc2626 !important; color: #dc2626 !important; font-weight: 600; }
  .btn-discard:hover { background: #dc2626; color: #fff; }
  .btn-proceed { background: #FFC107 !important; font-weight: 600 !important; color: white !important; border: none; }
  .btn-proceed:hover { background: #e6ac00 !important; color: white !important; }
</style>
{% endblock extra_css %}

{% block content %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0 font-size-18"><i class="bi bi-wallet2 me-2" style="color: #775599;"></i>Add Payment</h4>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="payment-form-card">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="payment-info-box">
              Payment ID: {{ payment_id|default:"PAY-TBD" }} | Date: {% if payment_date %}{{ payment_date|date:"d-m-Y" }}{% else %}Today{% endif %}
            </div>

            <h5 class="payment-form-title">Add Payment</h5>

            <div class="row g-4">
              <!-- 01. TRANSACTION CONTEXT -->
              <div class="col-lg-4">
                <div class="payment-section-header">01. Transaction context</div>
                <div class="mb-3">
                  <label class="form-label d-block">Transaction Type</label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="type" id="gave" value="gave" {% if form.instance.type == 'gave' or not form.instance.type %}checked{% endif %}>
                    <label class="btn btn-transaction btn-transaction-gave" for="gave">You Gave (Money Out)</label>
                    <input type="radio" class="btn-check" name="type" id="received" value="received" {% if form.instance.type == 'received' %}checked{% endif %}>
                    <label class="btn btn-transaction btn-transaction-received" for="received">You Received (Money In)</label>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label d-block">Party Type</label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="party_type" id="party-customer" value="customer" checked>
                    <label class="btn btn-party btn-party-active" for="party-customer">Customer</label>
                    <input type="radio" class="btn-check" name="party_type" id="party-vendor" value="vendor">
                    <label class="btn btn-party" for="party-vendor">Vendor</label>
                  </div>
                </div>
                <div class="mb-3" id="customer-dropdown">
                  <label class="form-label">Select Party</label>
                  {{ form.customer }}
                </div>
                <div class="mb-3" id="vendor-dropdown" style="display:none;">
                  <label class="form-label">Select Party</label>
                  {{ form.vendor }}
                </div>
              </div>

              <!-- 02. FINANCIAL DETAILS -->
              <div class="col-lg-4">
                <div class="payment-section-header">02. Financial details</div>
                <div class="mb-3">
                  <label class="form-label">Amount (â‚¹)</label>
                  {{ form.amount }}
                  {% if form.amount.errors %}<div class="invalid-feedback d-block">{{ form.amount.errors.0 }}</div>{% endif %}
                </div>
                <div class="mb-3">
                  <label class="form-label">Payment Date</label>
                  {{ form.payment_date }}
                </div>
                <div class="mb-3">
                  <label class="form-label d-block">Payment Mode</label>
                  <div class="btn-group w-100 btn-group-payment" role="group">
                    <button type="button" class="btn btn-payment {% if form.instance.payment_type == 'cash' or not form.instance.payment_type %}btn-payment-active{% endif %}" onclick="selectPayment('cash', this)">Cash</button>
                    <button type="button" class="btn btn-payment {% if form.instance.payment_type == 'upi' %}btn-payment-active{% endif %}" onclick="selectPayment('upi', this)">UPI</button>
                    <button type="button" class="btn btn-payment {% if form.instance.payment_type == 'cheque' %}btn-payment-active{% endif %}" onclick="selectPayment('cheque', this)">Cheque</button>
                  </div>
                  <input type="hidden" name="payment_type" id="payment_type" value="{{ form.instance.payment_type|default:'cash' }}">
                </div>
                <div class="mb-3" id="bank-dropdown" style="display:none;">
                  <label class="form-label">Bank Account (Optional)</label>
                  {{ form.bank }}
                </div>
              </div>

              <!-- 03. NOTES & PROOF -->
              <div class="col-lg-4">
                <div class="payment-section-header">03. Notes & proof</div>
                <div class="mb-3">
                  <label class="form-label">Description / Note</label>
                  {{ form.notes }}
                </div>
                <div class="mb-3">
                  <label class="form-label">Attachment</label>
                  <label class="payment-file-upload d-block" id="file-upload-label" for="id_attachment">
                    <i class="bi bi-paperclip d-block mb-2"></i>
                    <span id="file-upload-text">Drag file or Click to upload</span>
                    {{ form.attachment }}
                  </label>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2 justify-content-end pt-4">
              <a href="{% url 'list_payment' %}" class="btn btn-discard">Discard</a>
              <button type="submit" class="btn btn-proceed">Proceed</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
function selectPayment(method, btn) {
  document.getElementById('payment_type').value = method;
  var group = btn.closest('.btn-group-payment');
  if (group) group.querySelectorAll('.btn-payment').forEach(function(b) { b.classList.remove('btn-payment-active'); });
  btn.classList.add('btn-payment-active');
  var bankDropdown = document.getElementById('bank-dropdown');
  var bankSelect = document.getElementById('id_bank');
  if (method !== 'cash') {
    if (bankDropdown) bankDropdown.style.display = 'block';
    if (bankSelect) bankSelect.setAttribute('required', 'required');
  } else {
    if (bankDropdown) bankDropdown.style.display = 'none';
    if (bankSelect) { bankSelect.removeAttribute('required'); bankSelect.value = ''; }
  }
}

document.addEventListener("DOMContentLoaded", function() {
  // Set type from form if editing
  var typeInput = document.querySelector("input[name='type']:checked");
  if (typeInput) {
    var label = document.querySelector("label[for='" + typeInput.id + "']");
    if (label) {
      document.querySelectorAll(".btn-transaction").forEach(function(l) { l.classList.remove("btn-transaction-active"); });
      label.classList.add("btn-transaction-active");
    }
  }
  document.querySelectorAll("input[name='type']").forEach(function(r) {
    r.addEventListener("change", function() {
      document.querySelectorAll(".btn-transaction").forEach(function(l) { l.classList.remove("btn-transaction-active"); });
      document.querySelector("label[for='" + this.id + "']").classList.add("btn-transaction-active");
    });
  });

  // Party type toggle
  var customerDropdown = document.getElementById("customer-dropdown");
  var vendorDropdown = document.getElementById("vendor-dropdown");
  var customerSelect = document.getElementById("customer");
  var vendorSelect = document.getElementById("vendor");
  document.querySelectorAll("input[name='party_type']").forEach(function(radio) {
    radio.addEventListener("change", function() {
      document.querySelectorAll(".btn-party").forEach(function(l) { l.classList.remove("btn-party-active"); });
      document.querySelector("label[for='" + this.id + "']").classList.add("btn-party-active");
      if (this.value === "customer") {
        customerDropdown.style.display = "block";
        vendorDropdown.style.display = "none";
        if (vendorSelect) { vendorSelect.value = ""; vendorSelect.disabled = true; }
        if (customerSelect) customerSelect.disabled = false;
      } else {
        customerDropdown.style.display = "none";
        vendorDropdown.style.display = "block";
        if (customerSelect) { customerSelect.value = ""; customerSelect.disabled = true; }
        if (vendorSelect) vendorSelect.disabled = false;
      }
    });
  });
  // On load: disable the non-selected party field so only one is submitted
  var partyChecked = document.querySelector("input[name='party_type']:checked");
  if (partyChecked) {
    if (partyChecked.value === "customer" && vendorSelect) vendorSelect.disabled = true;
    else if (partyChecked.value === "vendor" && customerSelect) customerSelect.disabled = true;
  }

  // Payment type on load
  var pt = document.getElementById("payment_type");
  if (pt && pt.value && pt.value !== 'cash') {
    var bankRow = document.getElementById("bank-dropdown");
    if (bankRow) bankRow.style.display = "block";
  }

  // File upload label
  var fileInput = document.getElementById("id_attachment");
  var fileLabel = document.getElementById("file-upload-label");
  var fileText = document.getElementById("file-upload-text");
  if (fileInput && fileLabel && fileText) {
    fileInput.addEventListener("change", function() {
      if (this.files && this.files.length) {
        fileText.textContent = this.files[0].name;
        fileLabel.classList.add("has-file");
      } else {
        fileText.textContent = "Drag file or Click to upload";
        fileLabel.classList.remove("has-file");
      }
    });
  }
});
</script>
{% endblock extra_js %}
